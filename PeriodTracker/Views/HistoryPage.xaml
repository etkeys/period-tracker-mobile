<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:mauitoolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="PeriodTracker.HistoryPage"
             xmlns:viewmodel="clr-namespace:PeriodTracker.ViewModels"
             xmlns:local="clr-namespace:PeriodTracker"
             x:DataType="viewmodel:HistoryViewModel"
             Title="History">

    <ContentPage.Resources>
        <ResourceDictionary>
            <mauitoolkit:InvertedBoolConverter x:Key="InvertedBoolConverter" />
            <mauitoolkit:IsListNotNullOrEmptyConverter x:Key="IsListNotNullOrEmptyConverter" />
            <mauitoolkit:IsListNullOrEmptyConverter x:Key="IsListNullOrEmptyConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid
        Padding="30,0"
        RowSpacing="25">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        <Label 
            Grid.Row="0"
            Text="Cycle History"
            Style="{StaticResource Headline}"
            SemanticProperties.HeadingLevel="Level1"
            />

        <ActivityIndicator
            Grid.Row="1"
            IsRunning="{Binding IsBusy}"
            IsVisible="{Binding IsBusy}"
            Color="{StaticResource Primary}" />

        <Grid
            Grid.Row="2"
            IsVisible="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
            RowSpacing="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <Button
                Grid.Row="0"
                Text="Record start of period"
                Clicked="OnRecordNewClicked"
                IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                HorizontalOptions="Fill" />

            <CollectionView
                x:Name="cycleList"
                Grid.Row="1"
                ItemsSource="{Binding Cycles}"
                EmptyView="No cycles have been recorded"
            >
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="local:CycleHistory">
                        <Border
                            Margin="5"
                        >
                            <Grid
                                Margin="5"
                                VerticalOptions="Center"
                                >
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <HorizontalStackLayout
                                    Grid.Row="0"
                                    Grid.Column="0">
                                    <Label
                                        Text="{Binding StartDate, StringFormat='Start Date: {0:d}'}"
                                        />
                                </HorizontalStackLayout>
                                <HorizontalStackLayout
                                    Grid.Row="1"
                                    Grid.Column="0">
                                    <Label
                                        Text="{Binding CycleLengthDays, StringFormat='{0} days'}"
                                        />
                                </HorizontalStackLayout>
                                <HorizontalStackLayout
                                    Grid.Row="2"
                                    Grid.Column="0">
                                    <Label
                                        Text="{Binding RecordedDate, StringFormat='Recorded: {0:d}'}"
                                        Style="{StaticResource Muted}"
                                        />
                                </HorizontalStackLayout>
                                <ImageButton
                                    Grid.RowSpan="3"
                                    Grid.Row="0"
                                    Grid.Column="1"
                                    Command="{Binding Path=BindingContext.DeleteCycleCommand, Source={x:Reference cycleList}}"
                                    CommandParameter="{Binding}"
                                    Source="trash_can.png"
                                    HeightRequest="32"
                                    WidthRequest="32"
                                    Margin="5"
                                />

                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

        </Grid>

    </Grid>
</ContentPage>